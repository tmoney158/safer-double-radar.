import streamlit as st
import yfinance as yf
import pandas as pd

# Page setup
st.set_page_config(page_title="Safer Double Radar", layout="wide")
st.title("ðŸ“ˆ Safer Double Radar â€” Mid-Cap Double Candidates")
st.caption("Safer double probability based on volume, momentum, and consolidation")

# Mid-cap slightly safer stock list
TICKERS = [
    "AAPL","MSFT","NVDA","AMD","PLTR",
    "SOFI","NFLX","META","COIN","UPST",
    "RBLX","SNAP","DOCU","LCID","RIVN"
]

# Function to calculate Double Probability Score (DPS)
def scan_stock(ticker):
    stock = yf.Ticker(ticker)
    hist = stock.history(period="14d")  # last 2 weeks for stability

    if hist.empty or len(hist) < 3:
        return None

    price = hist["Close"][-1]
    price_range = (hist["High"].max() - hist["Low"].min()) / price
    compression_score = max(0, 1 - price_range)  # sideways = good

    volume_spike = hist["Volume"][-1] / hist["Volume"].mean()  # current vs avg
    momentum = (hist["Close"][-1] - hist["Close"][-3]) / hist["Close"][-3]  # short-term

    # DPS formula (tuned for safer mid-cap stocks)
    dps = (
        volume_spike * 35 +
        compression_score * 30 +
        momentum * 20
    )

    # Filter: only mid-cap range & minimum volume spike
    if price < 20 or price > 100 or volume_spike < 1.5:
        return None

    return {
        "Ticker": ticker,
        "Price": round(price, 2),
        "Change %": round(momentum * 100, 2),
        "Volume Spike": round(volume_spike, 2),
        "Double Probability Score": round(dps, 2)
    }

# Scan all tickers
data = []
with st.spinner("Scanning mid-cap stocks for double candidates..."):
    for t in TICKERS:
        result = scan_stock(t)
        if result:
            data.append(result)

# Display table sorted by DPS
df = pd.DataFrame(data)
if not df.empty:
    df = df.sort_values("Double Probability Score", ascending=False)
    st.subheader("ðŸ”¥ Top Safer Double Candidates")
    st.dataframe(df, use_container_width=True)

    # Dropdown to see chart
    selected = st.selectbox("ðŸ” View stock chart", df["Ticker"])
    stock = yf.Ticker(selected)
    chart_data = stock.history(period="1mo")
    st.subheader(f"ðŸ“Š {selected} Price Chart (Last 1 Month)")
    st.line_chart(chart_data["Close"])
else:
    st.warning("No mid-cap stocks meet the safer double criteria today. Check again later!")

st.info(
    "Double Probability Score (DPS) combines:\n"
    "- Volume Spike: early retail/momentum activity\n"
    "- Price Compression: sideways consolidation signals breakout potential\n"
    "- Short-term Momentum: beginning of upward movement\n\n"
    "Only mid-cap stocks ($20â€“$100) are included to reduce extreme risk."
)
